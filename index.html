<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wavelength Mini App</title>

  <!-- Telegram SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      font-family: Arial, sans-serif;
      text-align: center;
    }

    h1 {
      margin-top: 20px;
      margin-bottom: 10px;
    }

    canvas {
      display: block;
      margin: 20px auto;
    }

    .btn {
      border: 0;
      border-radius: 6px;
      height: 50px;
      width: 200px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      color: var(--tg-theme-button-text-color);
      background: var(--tg-theme-button-color);
      margin-bottom: 30px;
    }
  </style>
</head>

<body>

  <h1 id="title"></h1>
  <canvas id="dial" width="360" height="200"></canvas>

  <button id="send" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

  <script>

    // ---------- TELEGRAM ----------
    const params = new URLSearchParams(window.location.search);
    const MODE = params.get("mode");          // seer | guess
    const CENTER = params.get("center");      // —É–≥–æ–ª –≤ —Ä–∞–¥–∏–∞–Ω–∞—Ö (—Ç–æ–ª—å–∫–æ –¥–ª—è seer)
    const title = document.querySelector("h1");
    if (MODE === "seer") {
    title.textContent = "üëÅ –¢—ã —Ç–µ–ª–µ–ø–∞—Ç. –ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —Ä–∞–∑–º–µ—Ç–∫—É";
    }
    if (MODE === "guess") {
    title.textContent = "üéØ –ü–æ—Å—Ç–∞–≤—å —Å—Ç—Ä–µ–ª–∫—É";
    }

    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    if (MODE !== "seer" && MODE !== "guess") {
    tg.showAlert("–û—à–∏–±–∫–∞: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º Mini App");
    }
    if (MODE === "seer" && CENTER === null) {
    tg.showAlert("–û—à–∏–±–∫–∞: –Ω–µ—Ç —Ä–∞–∑–º–µ—Ç–∫–∏ –¥–ª—è —Ç–µ–ª–µ–ø–∞—Ç–∞");
    }


    // ---------- CANVAS ----------
    const canvas = document.getElementById("dial");
    const ctx = canvas.getContext("2d");
    const sendBtn = document.getElementById("send");

    const cx = canvas.width / 2;
    const cy = canvas.height;
    const radius = 150;

function drawArc(start, end, color) {
  ctx.beginPath();
  ctx.arc(cx, cy, radius, start, end);
  ctx.lineTo(cx, cy);
  ctx.fillStyle = color;
  ctx.fill();
}



   function drawMarking(centerAngle) {
  const canvasCenterAngle = Math.PI + (centerAngle + Math.PI/2);

  const zones = [
    { width: 0.04, color: "#f1c453" },
    { width: 0.04, color: "#ef476f" },
    { width: 0.04, color: "#118ab2" },
    { width: 0.04, color: "#ef476f" },
    { width: 0.04, color: "#f1c453" },
  ];

  const totalZoneWidth = zones.reduce((s, z) => s + z.width, 0) * Math.PI;

  // –†–∏—Å—É–µ–º –∑–æ–Ω—ã —Å –õ–ï–í–û–ô —Å—Ç–æ—Ä–æ–Ω—ã –æ—Ç —Ü–µ–Ω—Ç—Ä–∞
  let offset = totalZoneWidth / 2;
  for (let i = 0; i < zones.length; i++) {
    const zone = zones[i];
    const start = canvasCenterAngle - offset;
    const end = start + zone.width * Math.PI;

    const visibleStart = Math.max(start, Math.PI);
    const visibleEnd = Math.min(end, 2 * Math.PI);

    if (visibleEnd > visibleStart) {
      drawArc(visibleStart, visibleEnd, zone.color);
    }

    offset -= zone.width * Math.PI;
  }

  // –†–∏—Å—É–µ–º –∑–æ–Ω—ã —Å –ü–†–ê–í–û–ô —Å—Ç–æ—Ä–æ–Ω—ã –æ—Ç —Ü–µ–Ω—Ç—Ä–∞
  offset = 0;
  for (let i = 0; i < zones.length; i++) {
    const zone = zones[i];
    const start = canvasCenterAngle + offset;
    const end = start + zone.width * Math.PI;

    const visibleStart = Math.max(start, Math.PI);
    const visibleEnd = Math.min(end, 2 * Math.PI);

    if (visibleEnd > visibleStart) {
      drawArc(visibleStart, visibleEnd, zone.color);
    }

    offset += zone.width * Math.PI;
  }
}


console.log("centerAngle (from Python):", centerAngle);
console.log("canvasAngle (converted):", canvasAngle);
console.log("Visible range: [", Math.PI, ",", 2*Math.PI, "]");


    let angle = 0; // –≤—ã–±—Ä–∞–Ω–Ω—ã–π —É–≥–æ–ª

    function drawDial() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // –∫—Ä—É–≥
  ctx.beginPath();
  ctx.arc(cx, cy, radius, 0, 2 * Math.PI);
  ctx.fillStyle = "#7fffd4";
  ctx.fill();

  if (MODE === "seer") {
    drawMarking(parseFloat(CENTER));
  }

  if (MODE === "guess") {
    drawArrow();
  }

  ctx.fillStyle = "var(--tg-theme-bg-color, #ffffff)";
  ctx.fillRect(0, cy, canvas.width, canvas.height);

  ctx.restore();
}




    function drawArrow() {
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(angle);

      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.lineTo(0, -130);
      ctx.lineWidth = 6;
      ctx.strokeStyle = "#222";
      ctx.stroke();

      ctx.restore();
    }

    canvas.addEventListener("click", (e) => {
    if (MODE !== "guess") return;

    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left - cx;
    const y = cy - (e.clientY - rect.top);

    const a = Math.atan2(x, y);

    if (a >= -Math.PI / 2 && a <= Math.PI / 2) {
      angle = a;
      drawDial();
    }
    });

if (MODE === "seer") {
  sendBtn.style.display = "none";
}

    // ---------- SEND DATA ----------
    sendBtn.addEventListener("click", () => {
  if (MODE !== "guess") return;

  tg.sendData(JSON.stringify({ angle }));
});


    // —Å—Ç–∞—Ä—Ç
    drawDial();
  </script>
</body>
</html>

