<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wavelength Mini App</title>

  <!-- Telegram SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      font-family: Arial, sans-serif;
      text-align: center;
    }

    h1 {
      margin-top: 20px;
      margin-bottom: 10px;
    }

    canvas {
      display: block;
      margin: 20px auto;
    }

    .btn {
      border: 0;
      border-radius: 6px;
      height: 50px;
      width: 200px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      color: var(--tg-theme-button-text-color);
      background: var(--tg-theme-button-color);
      margin-bottom: 30px;
    }
  </style>
</head>

<body>

  <h1 id="title"></h1>
  <canvas id="dial" width="360" height="200"></canvas>

  <button id="send" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

  <script>

    // ---------- TELEGRAM ----------
    const params = new URLSearchParams(window.location.search);
    const MODE = params.get("mode");          // seer | guess
    const CENTER = params.get("center");      // —É–≥–æ–ª –≤ —Ä–∞–¥–∏–∞–Ω–∞—Ö (—Ç–æ–ª—å–∫–æ –¥–ª—è seer)
    const title = document.querySelector("h1");
    if (MODE === "seer") {
    title.textContent = "üëÅ –¢—ã —Ç–µ–ª–µ–ø–∞—Ç. –ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —Ä–∞–∑–º–µ—Ç–∫—É";
    }
    if (MODE === "guess") {
    title.textContent = "üéØ –ü–æ—Å—Ç–∞–≤—å —Å—Ç—Ä–µ–ª–∫—É";
    }

    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    if (MODE !== "seer" && MODE !== "guess") {
    tg.showAlert("–û—à–∏–±–∫–∞: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º Mini App");
    }
    if (MODE === "seer" && CENTER === null) {
    tg.showAlert("–û—à–∏–±–∫–∞: –Ω–µ—Ç —Ä–∞–∑–º–µ—Ç–∫–∏ –¥–ª—è —Ç–µ–ª–µ–ø–∞—Ç–∞");
    }


    // ---------- CANVAS ----------
    const canvas = document.getElementById("dial");
    const ctx = canvas.getContext("2d");
    const sendBtn = document.getElementById("send");

    const cx = canvas.width / 2;
    const cy = canvas.height;
    const radius = 150;
    const MIN = -Math.PI / 2;
    const MAX =  Math.PI / 2;
    const RANGE = Math.PI;


    function wrap(angle) {
  while (angle < MIN) angle += RANGE;
  while (angle > MAX) angle -= RANGE;
  return angle;
}

    function drawMarking(centerAngle) {
  const zones = [
    { score: 2, width: 0.04, color: "#f1c453" },
    { score: 3, width: 0.04, color: "#ef476f" },
    { score: 4, width: 0.04, color: "#118ab2" },
    { score: 3, width: 0.04, color: "#ef476f" },
    { score: 2, width: 0.04, color: "#f1c453" },
  ];

  const totalWidth = zones.reduce((s, z) => s + z.width, 0) * Math.PI;
  let offset = -totalWidth / 2;

  for (const z of zones) {
    let start = centerAngle + offset;
    let end   = start + z.width * Math.PI;

    // --- WRAP ---
    start = wrap(start);
    end   = wrap(end);

    ctx.beginPath();
    ctx.arc(
      cx,
      cy,
      radius,
      Math.PI + start,
      Math.PI + end
    );
    ctx.lineTo(cx, cy);
    ctx.fillStyle = z.color;
    ctx.fill();

    offset += z.width * Math.PI;
  }
}



    let angle = 0; // –≤—ã–±—Ä–∞–Ω–Ω—ã–π —É–≥–æ–ª

    function drawDial() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // –±–∞–∑–æ–≤—ã–π –ø–æ–ª—É–∫—Ä—É–≥

  ctx.beginPath();
  ctx.arc(cx, cy, radius, Math.PI, 2 * Math.PI);
  ctx.lineTo(cx, cy);
  ctx.closePath();
  ctx.fillStyle = "aquamarine";
  ctx.fill();


  ctx.strokeStyle = "#666";
  ctx.lineWidth = 2;
  ctx.stroke();


  if (MODE === "seer") {
    drawMarking(parseFloat(CENTER));
  }

  if (MODE === "guess") {
    drawArrow();
  }
}



    function drawArrow() {
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(angle);

      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.lineTo(0, -130);
      ctx.lineWidth = 6;
      ctx.strokeStyle = "#222";
      ctx.stroke();

      ctx.restore();
    }

    canvas.addEventListener("click", (e) => {
    if (MODE !== "guess") return;

    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left - cx;
    const y = cy - (e.clientY - rect.top);

    const a = Math.atan2(x, y);

    if (a >= -Math.PI / 2 && a <= Math.PI / 2) {
      angle = a;
      drawDial();
    }
    });

if (MODE === "seer") {
  sendBtn.style.display = "none";
}

    // ---------- SEND DATA ----------
    sendBtn.addEventListener("click", () => {
  if (MODE !== "guess") return;

  tg.sendData(JSON.stringify({ angle }));
});


    // —Å—Ç–∞—Ä—Ç
    drawDial();
  </script>
</body>
</html>

