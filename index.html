<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wavelength Mini App</title>

  <!-- Telegram SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      font-family: Arial, sans-serif;
      text-align: center;
    }

    h1 {
      margin-top: 20px;
      margin-bottom: 10px;
    }

    canvas {
      display: block;
      margin: 20px auto;
    }

    .btn {
      border: 0;
      border-radius: 6px;
      height: 50px;
      width: 200px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      color: var(--tg-theme-button-text-color);
      background: var(--tg-theme-button-color);
      margin-bottom: 30px;
    }
  </style>
</head>

<body>
  <h1>üéØ –í—ã–±–µ—Ä–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h1>

  <canvas id="dial" width="360" height="200"></canvas>

  <button id="send" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

  <script>
    // ---------- TELEGRAM ----------
    const params = new URLSearchParams(window.location.search);
    const MODE = params.get("mode"); // "seer" | "guess"
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    if (MODE !== "seer" && MODE !== "guess") {
    tg.showAlert("–û—à–∏–±–∫–∞: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º Mini App");
    }

    // ---------- CANVAS ----------
    const canvas = document.getElementById("dial");
    const ctx = canvas.getContext("2d");
    const sendBtn = document.getElementById("send");

    const cx = canvas.width / 2;
    const cy = canvas.height;
    const radius = 150;

    const segments = [
      { value: 2, color: "#f1c453" },
      { value: 3, color: "#ef476f" },
      { value: 4, color: "#118ab2" },
      { value: 3, color: "#ef476f" },
      { value: 2, color: "#f1c453" },
    ];

    const total = segments.reduce((s, x) => s + x.value, 0);

    let angle = 0; // –≤—ã–±—Ä–∞–Ω–Ω—ã–π —É–≥–æ–ª

    function drawDial() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  
    if (MODE === "seer") {
      // —Ä–∏—Å—É–µ–º —Ü–≤–µ—Ç–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã
      let start = Math.PI;
      for (const seg of segments) {
        const slice = Math.PI * (seg.value / total);
  
        ctx.beginPath();
        ctx.arc(cx, cy, radius, start, start + slice);
        ctx.lineTo(cx, cy);
        ctx.fillStyle = seg.color;
        ctx.fill();
  
        start += slice;
      }
    } else {
      // –ø—É—Å—Ç–æ–π –ø–æ–ª—É–∫—Ä—É–≥
      ctx.beginPath();
      ctx.arc(cx, cy, radius, Math.PI, 2 * Math.PI);
      ctx.strokeStyle = "#666";
      ctx.lineWidth = 3;
      ctx.stroke();
    }
  
    if (MODE === "guess") {
      drawArrow();
    }
    }


    function drawArrow() {
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(angle);

      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.lineTo(0, -130);
      ctx.lineWidth = 6;
      ctx.strokeStyle = "#222";
      ctx.stroke();

      ctx.restore();
    }

    canvas.addEventListener("click", (e) => {
    if (MODE !== "guess") return;
  
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left - cx;
    const y = cy - (e.clientY - rect.top);
  
    const a = Math.atan2(x, y);
  
    if (a >= -Math.PI / 2 && a <= Math.PI / 2) {
      angle = a;
      drawDial();
    }
    });

if (MODE === "seer") {
  sendBtn.style.display = "none";
}

    // ---------- SEND DATA ----------
    sendBtn.addEventListener("click", () => {
  if (MODE !== "guess") return;

  tg.sendData(JSON.stringify({ angle }));
});


    // —Å—Ç–∞—Ä—Ç
    drawDial();
  </script>
</body>
</html>

